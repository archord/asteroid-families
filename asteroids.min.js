// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t,e){return null!==t&&hasOwnProperty.call(t,e)}function e(t){var e=255*(parseFloat(t.astar)+.3)*2;0>e&&(e=0),e>255&&(e=255);var a=255-e,n=255*(parseFloat(t.iz)+.5)*1.42;return 0>n&&(n=0),n>255&&(n=255),t.iz<0&&(e*=1+parseFloat(t.iz)),"rgb("+Math.floor(e)+","+Math.floor(255-n)+","+Math.floor(a)+")"}function a(t){var e=b(f,t);return e[0]*=j,e[2]*=j,[e[0]+F.h,-e[2]+F.v]}function r(t){d3.select("#ae").style("background",function(){return"ae"===t?q:B}),d3.select("#ai").style("background",function(){return"ai"===t?q:B}),d3.select("#ei").style("background",function(){return"ei"===t?q:B}),R.translate([O.invert(I[2]),O.invert(I[0])]),o()}function o(){if(j=R.scale(),d3.event&&d3.event.sourceEvent&&"wheel"!==d3.event.sourceEvent.type){var t=R.translate();I=[O(t[1]),0,O(t[0])]}f=k(I),u.clearRect(0,0,A+2*S.h,N+2*S.v);for(var e in h)h[e](u);for(var a=0;a<C.length;a++)c(C[a]);if(E){for(u.textAlign="center",u.textBaseline="middle",u.font=M,u.globalAlpha=.6,a=0;a<D.length;a++){var n=D[a];u.fillStyle=n.col,l(n.n,n.pos)}u.globalAlpha=1}}function i(t){A=t-2*S.h,N=t-2*S.v,T=A/2,F={h:T+S.h,v:T+S.h},L.ap.range([-T,T]),L.ep.range([-T,T]),L.ip.range([-T,T]),O.domain([-T,T])}function c(t){u.fillStyle=t.col;var e=a(t.pos);u.beginPath(),u.arc(e[0],e[1],t.r,0,2*Math.PI),u.closePath(),u.fill()}function s(t){var e;u.beginPath();for(var n=0;n<t.length;n++)e=a(t[n]),0===n?u.moveTo(e[0],e[1]):u.lineTo(e[0],e[1]);u.stroke()}function l(t,e,n){var r=a(e);n?(u.save(),u.translate(r[0],r[1]),u.rotate(Math.PI/2),u.fillText(t,0,0),u.restore()):u.fillText(t,r[0],r[1])}var f,u,h,b=function(t,e){for(var a=[],n=0;3>n;n++){for(var r=0,o=0;3>o;o++)r+=t[n][o]*e[o];a[n]=r}return a},g=function(t,e){for(var a=[],n=0;3>n;n++){a[n]=[];for(var r=0;3>r;r++){for(var o=0,i=0;3>i;i++)o+=e[n][i]*t[i][r];a[n][r]=o}}return a},k=function(t){return g(p("z",t[2]),p("x",t[0]))},p=function(t,e){var a=-e*Math.PI/180,n=Math.cos(a),r=Math.sin(a);switch(t){case"x":return[[1,0,0],[0,n,r],[0,-r,n]];case"y":return[[n,0,-r],[0,1,0],[r,0,n]];case"z":return[[n,r,0],[-r,n,0],[0,0,1]]}},d=function(t){var a,n=L.ap(t.ap),r=L.ep(t.ep),o=L.ip(t.sinip),i=e(t);return a=t.H&&""!==t.H?Math.sqrt(w+1-t.H):.9,{pos:[n,r,o],col:i,r:a}},v=function(t){var e=L.ap(t.ap),a=L.ep(t.ep),r=L.ip(t.sinip);return col="#fff",n=t.Name,{pos:[e,a,r],col:col,n:n}},m={bottomfront:1,topfront:1,bottomback:1,topback:1,bottomleft:1,topleft:1,bottomright:1,topright:1,leftfront:1,rightfront:1,leftback:1,rightback:1},y=function(){function t(t){t.strokeStyle=y,t.lineWidth=x,t.textAlign="center",t.textBaseline="middle",t.setLineDash(z);var r=e(i);if(s(r),t.fillStyle=y,""!==p){t.font=v;var c=o.range(),f=(c[0]+c[1])/2,g=a(f,h),m=n(g,h);l(p,m)}if(0!==b){t.font=d;var P=o.ticks(b);P.forEach(function(t,e){var r=o(t);if(tick=a(r),s(tick),e%k===0){var i=n(tick,u);l(t,i)}})}}function e(t){var e,a=T,n=o.range();switch(t.join("")){case"bottomfront":e=[[n[0],-a,-a],[n[1],-a,-a]];break;case"topfront":e=[[n[0],a,-a],[n[1],a,-a]];break;case"bottomback":e=[[n[0],-a,a],[n[1],-a,a]];break;case"topback":e=[[n[0],a,a],[n[1],a,a]];break;case"bottomleft":e=[[-a,n[0],-a],[-a,n[1],-a]];break;case"topleft":e=[[a,n[0],-a],[a,n[1],-a]];break;case"bottomright":e=[[-a,n[0],a],[-a,n[1],a]];break;case"topright":e=[[a,n[0],a],[a,n[1],a]];break;case"leftfront":e=[[-a,-a,n[0]],[-a,-a,n[1]]];break;case"rightfront":e=[[a,-a,n[0]],[a,-a,n[1]]];break;case"leftback":e=[[-a,a,n[0]],[-a,a,n[1]]];break;case"rightback":e=[[a,a,n[0]],[a,a,n[1]]];break;default:e=[]}return e}function a(t){var e,a=T,n=c,r=f;switch(i.join("")){case"bottomfront":e=[[t,-a+n,-a+n],[t,-a-r,-a-r]];break;case"topfront":e=[[t,a-n,-a-n],[t,a+r,-a+r]];break;case"bottomback":e=[[t,-a+n,a+n],[t,-a-r,a-r]];break;case"topback":e=[[t,a-n,a-n],[t,a+r,a+r]];break;case"bottomleft":e=[[-a+n,t,-a+n],[-a-r,t,-a-r]];break;case"topleft":e=[[a-n,t,-a-n],[a+r,t,-a+r]];break;case"bottomright":e=[[-a+n,t,a+n],[-a-r,t,a-r]];break;case"topright":e=[[a-n,t,a-n],[a+r,t,a+r]];break;case"leftfront":e=[[-a+n,-a+n,t],[-a-r,-a-r,t]];break;case"rightfront":e=[[a-n,-a-n,t],[a+r,-a+r,t]];break;case"leftback":e=[[-a+n,a+n,t],[-a-r,a-r,t]];break;case"rightback":e=[[a-n,a-n,t],[a+r,a+r,t]];break;default:e=[]}return e}function n(t,e){var a=t[1];switch(i.join("")){case"bottomfront":case"bottomback":a[1]-=e,a[2]-=e;break;case"topfront":case"topback":a[1]+=e,a[2]+=e;break;case"bottomleft":case"bottomright":a[0]-=e,a[2]-=e;break;case"topleft":case"topright":a[0]+=e,a[2]+=e;break;case"leftfront":case"leftback":a[0]-=e,a[1]-=e;break;case"rightfront":case"rightback":a[0]+=e,a[1]+=e;break;default:a=[]}return a}var r,o=d3.scale.linear(),i=["bottom","front"],c=5,f=5,u=4,h=14,b=[],g=null,k=5,p="",d="10px sans-serif",v="14px sans-serif",y="#fff",x=1,z=[];return t.scale=function(e){return arguments.length?(o=e,t):o},t.orient=function(e){return arguments.length?(e.join("")in m&&(i=e),t):i},t.ticks=function(){return arguments.length?(b=Array.prototype.slice.call(arguments),t):b},t.tickValues=function(e){return arguments.length?(g=e,t):g},t.tickFormat=function(e){return arguments.length?(r=e,t):r},t.tickSize=function(e){var a=arguments.length;return a?(c=+e,f=+arguments[a-1],t):c},t.innerTickSize=function(e){return arguments.length?(c=+e,t):c},t.outerTickSize=function(e){return arguments.length?(f=+e,t):f},t.tickPadding=function(e){return arguments.length?(u=+e,t):u},t.titlePadding=function(e){return arguments.length?(h=+e,t):h},t.tickSubdivide=function(){return arguments.length&&t},t.dash=function(e){return arguments.length?(z=e,t):z},t.values=function(e){return arguments.length?(k=+e,t):k},t.title=function(e){return arguments.length?(p=e,t):p},t.font=function(e){return arguments.length?(d=e,t):d},t.titleFont=function(e){return arguments.length?(v=e,t):v},t},x={version:"0.1",svg:null},z="ast-proper14.csv",P="./data/",w=14,M="12px sans-serif",S={h:40,v:20},A=640-2*S.h,N=640-2*S.v,T=A/2,F={h:T+S.h,v:T+S.h},j=.9,E=!0,H={ae:[0,0,0],ai:[90,0,0],ei:[0,0,-90]},I=H.ae,B="rgba(255,255,255,0.1)",q="rgba(255,255,255,0.3)",C=[],D=[],L={ap:d3.scale.linear().domain([2,3.7]).range([-T,T]),ep:d3.scale.linear().domain([0,.3]).range([-T,T]),ip:d3.scale.linear().domain([0,.3]).range([-T,T])},O=d3.scale.linear().domain([-T,T]).range([-90,90]),R=d3.behavior.zoom().center([0,0]).scaleExtent([.7,3]).scale(j).on("zoom",o);f=k(I),x.display=function(e){e&&(t(e,"width")&&i(e.width),t(e,"datapath")&&(P=e.datapath)),u=d3.select("#map").append("canvas").attr("width",A+2*S.h).attr("height",N+2*S.v).call(R).node().getContext("2d");var a=d3.select("#map").append("div").attr("class","ctrl").html("Show ");a.append("button").attr("class","button").style("background",q).attr("id","ae").html("a vs. e").on("click",function(){I=H.ae,r("ae")}),a.append("button").attr("class","button").attr("id","ai").html("a vs. sin i").on("click",function(){I=H.ai,r("ai")}),a.append("button").attr("class","button").attr("id","ae").html("e vs. sin i").on("click",function(){I=H.ei,r("ei")}),a.append("button").attr("class","button").attr("id","names").html("No Names").on("click",function(){E=!E,d3.select("#names").html(function(){return E?"No Names":"Names"}),o()}),h={x:y().scale(L.ap).ticks(17).tickPadding(6).title("aₚ / AU"),y:y().scale(L.ep).orient(["left","front"]).ticks(12).tickPadding(6).title("eₚ"),z:y().scale(L.ip).orient(["bottom","left"]).ticks(12).tickPadding(6).title("sin iₚ"),x1:y().scale(L.ap).orient(["top","front"]).ticks(0).dash([2,4]),x2:y().scale(L.ap).orient(["bottom","back"]).ticks(0).dash([2,4]),x3:y().scale(L.ap).orient(["top","back"]).ticks(0).dash([2,4]),y1:y().scale(L.ep).orient(["right","front"]).ticks(0).dash([2,4]),y2:y().scale(L.ep).orient(["left","back"]).ticks(0).dash([2,4]),y3:y().scale(L.ep).orient(["right","back"]).ticks(0).dash([2,4]),z1:y().scale(L.ip).orient(["top","left"]).ticks(0).dash([2,4]),z2:y().scale(L.ip).orient(["bottom","right"]).ticks(0).dash([2,4]),z3:y().scale(L.ip).orient(["top","right"]).ticks(0).dash([2,4])},R.translate([O.invert(I[0]),O.invert(I[2])]),d3.csv(P+z,function(e,a){if(e)return console.log(e);for(var n in a)t(a,n)&&C.push(d(a[n]));o()}),d3.csv(P+"families.csv",function(e,a){if(e)return console.log(e);for(var n in a)t(a,n)&&D.push(v(a[n]));o()})},this.Asteroids=x}();