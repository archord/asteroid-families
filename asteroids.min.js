// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t,e){return null!==t&&hasOwnProperty.call(t,e)}function e(t){var e=255*(parseFloat(t.astar)+.3)*2;0>e&&(e=0),e>255&&(e=255);var n=255-e,a=255*(parseFloat(t.iz)+.5)*1.42;return 0>a&&(a=0),a>255&&(a=255),t.iz<0&&(e*=1+parseFloat(t.iz)),"rgb("+Math.floor(e)+","+Math.floor(255-a)+","+Math.floor(n)+")"}function a(t){var e=u(s,t);return e[0]*=E,e[2]*=E,[e[0]+j,-e[2]+j]}function r(){if(E=C.scale(),d3.event&&d3.event.sourceEvent&&"wheel"!==d3.event.sourceEvent.type){var t=C.translate();I=[x(t[1]),0,z(t[0])]}s=g(I),l.clearRect(0,0,A+2*w,T+2*w);for(var e in f)f[e](l);for(var n=0;n<y.length;n++)o(y[n]);if(S){l.textAlign="center",l.textBaseline="middle",l.font=M,l.globalAlpha=.6;for(var n=0;n<P.length;n++){var a=P[n];l.fillStyle=a.col,c(a.n,a.pos)}l.globalAlpha=1}}function o(t){l.fillStyle=t.col;var e=a(t.pos);l.beginPath(),l.arc(e[0],e[1],t.r,0,2*Math.PI),l.closePath(),l.fill()}function i(t){var e;l.beginPath();for(var n=0;n<t.length;n++)e=a(t[n]),0===n?l.moveTo(e[0],e[1]):l.lineTo(e[0],e[1]);l.stroke()}function c(t,e,n){var r=a(e);n?(l.save(),l.translate(r[0],r[1]),l.rotate(Math.PI/2),l.fillText(t,0,0),l.restore()):l.fillText(t,r[0],r[1])}var s,l,f,u=function(t,e){for(var n=[],a=0;3>a;a++){for(var r=0,o=0;3>o;o++)r+=t[a][o]*e[o];n[a]=r}return n},k=function(t,e){for(var n=[],a=0;3>a;a++){n[a]=[];for(var r=0;3>r;r++){for(var o=0,i=0;3>i;i++)o+=e[a][i]*t[i][r];n[a][r]=o}}return n},g=function(t){return k(h("z",t[2]),h("x",t[0]))},h=function(t,e){var n=-e*Math.PI/180,a=Math.cos(n),r=Math.sin(n);switch(t){case"x":return[[1,0,0],[0,a,r],[0,-r,a]];case"y":return[[a,0,-r],[0,1,0],[r,0,a]];case"z":return[[a,r,0],[-r,a,0],[0,0,1]]}},b=function(t){var n,a=B.ap(t.ap),r=B.ep(t.ep),o=B.ip(t.sinip),i=e(t);return n=t.H&&""!==t.H?12-t.H:.8,{pos:[a,r,o],col:i,r:n}},p=function(t){var e=B.ap(t.ap),a=B.ep(t.ep),r=B.ip(t.sinip);return col="#fff",n=t.Name,{pos:[e,a,r],col:col,n:n}},d={bottomfront:1,topfront:1,bottomback:1,topback:1,bottomleft:1,topleft:1,bottomright:1,topright:1,leftfront:1,rightfront:1,leftback:1,rightback:1},v=function(){function t(t){t.strokeStyle=x,t.lineWidth=z,t.textAlign="center",t.textBaseline="middle",t.setLineDash(y);var r=e(s);if(i(r),t.fillStyle=x,""!=p){t.font=m;var l=o.range(),f=(l[0]+l[1])/2,h=n(f,k),d=a(h,k);c(p,d)}if(0!=g){t.font=v;var P=o.ticks(g);P.forEach(function(t,e){var r=o(t);if(tick=n(r),i(tick),e%b==0){var s=a(tick,u);c(t,s)}})}}function e(t){var e,n=F,a=o.range();switch(t.join("")){case"bottomfront":e=[[a[0],-n,-n],[a[1],-n,-n]];break;case"topfront":e=[[a[0],n,-n],[a[1],n,-n]];break;case"bottomback":e=[[a[0],-n,n],[a[1],-n,n]];break;case"topback":e=[[a[0],n,n],[a[1],n,n]];break;case"bottomleft":e=[[-n,a[0],-n],[-n,a[1],-n]];break;case"topleft":e=[[n,a[0],-n],[n,a[1],-n]];break;case"bottomright":e=[[-n,a[0],n],[-n,a[1],n]];break;case"topright":e=[[n,a[0],n],[n,a[1],n]];break;case"leftfront":e=[[-n,-n,a[0]],[-n,-n,a[1]]];break;case"rightfront":e=[[n,-n,a[0]],[n,-n,a[1]]];break;case"leftback":e=[[-n,n,a[0]],[-n,n,a[1]]];break;case"rightback":e=[[n,n,a[0]],[n,n,a[1]]];break;default:e=[]}return e}function n(t){var e,n=F,a=l,r=f;switch(s.join("")){case"bottomfront":e=[[t,-n+a,-n+a],[t,-n-r,-n-r]];break;case"topfront":e=[[t,n-a,-n-a],[t,n+r,-n+r]];break;case"bottomback":e=[[t,-n+a,n+a],[t,-n-r,n-r]];break;case"topback":e=[[t,n-a,n-a],[t,n+r,n+r]];break;case"bottomleft":e=[[-n+a,t,-n+a],[-n-r,t,-n-r]];break;case"topleft":e=[[n-a,t,-n-a],[n+r,t,-n+r]];break;case"bottomright":e=[[-n+a,t,n+a],[-n-r,t,n-r]];break;case"topright":e=[[n-a,t,n-a],[n+r,t,n+r]];break;case"leftfront":e=[[-n+a,-n+a,t],[-n-r,-n-r,t]];break;case"rightfront":e=[[n-a,-n-a,t],[n+r,-n+r,t]];break;case"leftback":e=[[-n+a,n+a,t],[-n-r,n-r,t]];break;case"rightback":e=[[n-a,n-a,t],[n+r,n+r,t]];break;default:e=[]}return e}function a(t,e){var n=t[1];switch(s.join("")){case"bottomfront":case"bottomback":n[1]-=e,n[2]-=e;break;case"topfront":case"topback":n[1]+=e,n[2]+=e;break;case"bottomleft":case"bottomright":n[0]-=e,n[2]-=e;break;case"topleft":case"topright":n[0]+=e,n[2]+=e;break;case"leftfront":case"leftback":n[0]-=e,n[1]-=e;break;case"rightfront":case"rightback":n[0]+=e,n[1]+=e;break;default:n=[]}return n}var r,o=d3.scale.linear(),s=["bottom","front"],l=5,f=5,u=4,k=14,g=[],h=null,b=5,p="",v="10px sans-serif",m="14px sans-serif",x="#fff",z=1,y=[];return t.scale=function(e){return arguments.length?(o=e,t):o},t.orient=function(e){return arguments.length?(e.join("")in d&&(s=e),t):s},t.ticks=function(){return arguments.length?(g=Array.prototype.slice.call(arguments),t):g},t.tickValues=function(e){return arguments.length?(h=e,t):h},t.tickFormat=function(e){return arguments.length?(r=e,t):r},t.tickSize=function(e){var n=arguments.length;return n?(l=+e,f=+arguments[n-1],t):l},t.innerTickSize=function(e){return arguments.length?(l=+e,t):l},t.outerTickSize=function(e){return arguments.length?(f=+e,t):f},t.tickPadding=function(e){return arguments.length?(u=+e,t):u},t.titlePadding=function(e){return arguments.length?(k=+e,t):k},t.tickSubdivide=function(){return arguments.length&&t},t.dash=function(e){return arguments.length?(y=e,t):y},t.values=function(e){return arguments.length?(b=+e,t):b},t.title=function(e){return arguments.length?(p=e,t):p},t.font=function(e){return arguments.length?(v=e,t):v},t.titleFont=function(e){return arguments.length?(m=e,t):m},t},m={version:"0.1",svg:null},y=[],P=[],M="12px sans-serif",S=!0,w=25,A=600-2*w,T=A,F=A/2,j=F+w,E=.9,H={ae:[0,0,0],ai:[90,0,0],ei:[0,0,-90]},I=H.ae,B={ap:d3.scale.linear().domain([2,3.7]).range([-F,F]),ep:d3.scale.linear().domain([0,.3]).range([-F,F]),ip:d3.scale.linear().domain([0,.3]).range([-F,F])};x=d3.scale.linear().domain([-A/2,A/2]).range([-90,90]),z=d3.scale.linear().domain([-T/2,T/2]).range([-90,90]);var C=d3.behavior.zoom().center([0,0]).scaleExtent([.7,3]).translate([x.invert(I[0]),z.invert(I[2])]).scale(E).on("zoom",r);d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]});s=g(I),m.display=function(e){d3.select("#names").on("click",function(){S=!S,r()}),d3.select("#ae").on("click",function(){I=H.ae,C.translate([x.invert(I[2]),z.invert(I[0])]),r()}),d3.select("#ai").on("click",function(){I=H.ai,C.translate([x.invert(I[2]),z.invert(I[0])]),r()}),d3.select("#ei").on("click",function(){I=H.ei,C.translate([x.invert(I[2]),z.invert(I[0])]),r()}),l=d3.select("#map").append("canvas").attr("width",A+2*w).attr("height",T+2*w).call(C).node().getContext("2d"),f={x:v().scale(B.ap).ticks(17).tickPadding(6).title("aₚ / AU"),y:v().scale(B.ep).orient(["left","front"]).ticks(12).tickPadding(6).title("eₚ"),z:v().scale(B.ip).orient(["bottom","left"]).ticks(12).tickPadding(6).title("sin iₚ"),x1:v().scale(B.ap).orient(["top","front"]).ticks(0).dash([2,4]),x2:v().scale(B.ap).orient(["bottom","back"]).ticks(0).dash([2,4]),x3:v().scale(B.ap).orient(["top","back"]).ticks(0).dash([2,4]),y1:v().scale(B.ep).orient(["right","front"]).ticks(0).dash([2,4]),y2:v().scale(B.ep).orient(["left","back"]).ticks(0).dash([2,4]),y3:v().scale(B.ep).orient(["right","back"]).ticks(0).dash([2,4]),z1:v().scale(B.ip).orient(["top","left"]).ticks(0).dash([2,4]),z2:v().scale(B.ip).orient(["bottom","right"]).ticks(0).dash([2,4]),z3:v().scale(B.ip).orient(["top","right"]).ticks(0).dash([2,4])},d3.csv("data/ast-proper14.csv",function(e,n){if(e)return console.log(e);for(var a in n)t(n,a)&&y.push(b(n[a]));r()}),d3.csv("data/families.csv",function(e,n){if(e)return console.log(e);for(var a in n)t(n,a)&&P.push(p(n[a]));r()})},this.Asteroids=m}();